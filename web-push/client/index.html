<!DOCTYPE html>
<html>

<head>
    <script src="https://www.gstatic.com/firebasejs/7.18.0/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.18.0/firebase-messaging.js"></script>
    <script src="https://www.gstatic.com/firebasejs/7.18.0/firebase-analytics.js"></script>
    <script>
        //
        // Browser detection - TODO, move this to new script to keep code tidy!
        //

        // Opera 8.0+
        var isOpera = (!!window.opr && !!opr.addons) || !!window.opera || navigator.userAgent.indexOf(' OPR/') >= 0;
        // Firefox 1.0+
        var isFirefox = typeof InstallTrigger !== 'undefined';
        // Safari 3.0+ "[object HTMLElementConstructor]" 
        var isSafari = /constructor/i.test(window.HTMLElement) || (function (p) { return p.toString() === "[object SafariRemoteNotification]"; })(!window['safari'] || (typeof safari !== 'undefined' && safari.pushNotification));
        // Internet Explorer 6-11
        var isIE = /*@cc_on!@*/false || !!document.documentMode;
        // Edge 20+
        var isEdge = !isIE && !!window.StyleMedia;
        // Chrome 1 - 79
        var isChrome = !!window.chrome && (!!window.chrome.webstore || !!window.chrome.runtime);
        // Edge (based on chromium) detection
        var isEdgeChromium = isChrome && (navigator.userAgent.indexOf("Edg") != -1);
        // Blink engine detection
        var isBlink = (isChrome || isOpera) && !!window.CSS;
        function browser() {
            // Opera 8.0+
            if(isOpera) {
                return "Opera8.0+";
            }
            // Firefox 1.0+
            if(isFirefox) {
                return "firefox1.0+";
            }
            // Safari 3.0+ "[object HTMLElementConstructor]" 
            if(isSafari) {
                return "safari3.0+";
            }
            // Internet Explorer 6-11
            if (isIE) {
                return "IE6-11";
            }
            // Edge 20+
            if (isEdge) {
                return "Edge20+";
            }
            // Chrome 1 - 79
            if (isChrome) {
                return "Chrome1-79";
            }
            // Edge (based on chromium) detection
            if (isBlink) {
                return "Blink";
            }
        }

        firebase.initializeApp({
            apiKey: "AIzaSyAmaQpj-HpYZHOLL08737doT4QM1xIcnkw",
            authDomain: "mr-data-fcm.firebaseapp.com",
            databaseURL: "https://mr-data-fcm.firebaseio.com",
            projectId: "mr-data-fcm",
            storageBucket: "mr-data-fcm.appspot.com",
            messagingSenderId: "351645999964",
            appId: "1:351645999964:web:1748b1dbb38c49c31c1799",
            measurementId: "G-KH2FXB7E6M"
        })
        firebase.analytics();
        const messaging = firebase.messaging();
        async function initFirebaseMessagingRegistration() {
            messaging
                .requestPermission()
                .then(function () {
                    messageElement.innerHTML = "Got notification permission";
                    console.log("Got notification permission");
                    return messaging.getToken();
                })
                .then(async function (token) {
                    var url = new URL(window.location.href);
                    var userId = url.searchParams.get("userId");
                    var guildId = url.searchParams.get("guildId");
                    console.log(userId);
                    // print the token on the HTML page
                    tokenElement.innerHTML = "Token is: " + token + "<br/>" +
                        "User id is: " + userId + "<br/>" +
                        "Guild id is: " + guildId + "<br/>";
                    await fetch(`/subscribe?userId=${userId}&guildId=${guildId}`, {
                        method: 'POST',
                        body: JSON.stringify({token: `${token}`}),
                        headers: {
                            'Content-Type': 'application/json',
                        },
                    });
                })
                .catch(function (err) {
                    errorElement.innerHTML = "<span style='color:#FF0000'>I did not get notification permission.<br/>At this moment in timeError: " + err;
                    console.log("Didn't get notification permission", err);
                });
        }
        messaging.onMessage(function (payload) {
            console.log("Message received. ", JSON.stringify(payload));
            notificationElement.innerHTML = notificationElement.innerHTML + " " + payload.data.notification;
        });
        messaging.onTokenRefresh(function () {
            messaging.getToken()
                .then(function (refreshedToken) {
                    console.log('Token refreshed.');
                    tokenElement.innerHTML = "Token is " + refreshedToken;

                }).catch(function (err) {
                    errorElement.innerHTML = "Error: " + err;
                    console.log('Unable to retrieve refreshed token ', err);
                });
        });
    </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Push Notifications using Node.js and Firebase Messaging Web Push</title>
    <link rel="icon" type="image/png" href="https://d2cy1obokpvee9.cloudfront.net/manifest/favicon-196x196.png" sizes="196x196" class="next-head">
    <link rel="stylesheet" href="style.css">
</head>

<body>
    <header>
        <h1>Firebase Messaging (Push Notifications) Demo</h1>
    </header>
    <p>
        This is a web front-end for MrData.  Register for a test push notification by
        pressing the button below.<br/><br/></p><p>Join us on <a href="https://discord.gg/xzAs2yy">the Bot Factory Discord Server</a>.
        <script>
            if (isSafari) {
                document.write("\n\nSadly, you are running a sub-standard browser, which does not support advanced and " +
                                "modern features, such as push-notifications.  We are currently working on a solution " +
                                "which will enable users of Half-Eaten fruit products to enjoy the same benefits as the " +
                                "rest of the world.  Please bear with us whilst we develop such a tool.  In the meantime, " +
                                "you might like to <a href='https://apps.apple.com/us/app/google-chrome/id535886823' target='_blank'>" +
                                "visit the app store and install a man's browser!</a>");
            }
        </script>
        <br/><br/>
    </p>
    
    <div id="token" style="color:lightblue"></div>
    <div id="message" style="color:lightblue"></div>
    <div id="notification" style="color:green"></div>
    <div id="error" style="color:red"></div>
    <script>
        messageElement = document.getElementById("message")
        tokenElement = document.getElementById("token")
        notificationElement = document.getElementById("notification")
        errorElement = document.getElementById("error")
    </script><p>
    <button onclick="initFirebaseMessagingRegistration()"><span style="color:black">Enable Firebase Messaging</span></button></p>
</html>